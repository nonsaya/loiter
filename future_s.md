# 将来計画の詳細

本文書は、Livox MID360・GLIM・MAVROS を基盤とした自律飛行プロジェクトの拡張計画を、実装の易しさと現場価値の順に整理したものです。

---

## 現在のベースライン

本プロジェクトは次の基盤を構築済みです。

- **LiDAR と自己位置推定**: Livox MID360（Ethernet接続）の点群を GLIM（CPU版）で処理し、`/glim_ros/odom` で自己位置推定を出力。
- **MAVROS との統合**: 自己位置を `/mavros/odometry/in` に供給し、ArduPilot の EKF3 が外部推定として取り込む構成。結果として LOITER（その場ホバリング）が安定。
- **一発起動**: `scripts/launch_loiter_tmux.sh` で MID360/GLIM/MAVROS/ブリッジを tmux で並行起動。
- **ドキュメント整備**: `Libox2Glim.md`（ゼロからの復旧手順）・`future.md`（技術計画）で SSD 破損時も復旧可能。

この状態は、現場での最低限の安全デモと運用に十分な下地であり、次の拡張への出発点として整っています。

---

## ステージ1: 記録・再生（逆再生を含む）

### 目的
手動操縦でうまく飛行できた軌跡を記録し、同じ経路を自動で再生できるようにします。逆順（来た道を戻る）再生も実現します。

### 方法
- **記録対象**: `/mavros/local_position/pose`（EKF 出力）または `/glim_ros/odom`（GLIM 出力）。タイムスタンプ・位置 (x,y,z)・向き (yaw) を CSV もしくは rosbag に保存。開始点を原点化して相対軌跡として記録すれば、再生時に現在の開始位置に平行移動しやすく、異なる離陸地点でも使いやすくなります。
- **再生処理**:
  1. 記録した相対軌跡を、現在の開始位置へ平行移動（オフセット加算）
  2. スプライン補間や速度/加速度上限フィルタで滑らかな setpoint 列を生成
  3. 20Hz で `/mavros/setpoint_position/local`（または `/mavros/setpoint_raw/local`）に配信
  4. 到達判定（距離誤差＋時間許容）で次点へ遷移
- **逆再生**: 点列を「終端→始端」の順にたどり、yaw は軌跡接線方向か、固定（機体は前方のまま後退）のいずれかを選択。
- **安全**: 速度/加速度の上限値を厳しめに設定。途中で RC 介入があれば即座に LOITER へ退避。ジオフェンス、高度上限、タイムアウトロジックを組み込み。

### KPI
- 追従誤差（記録軌跡と実軌跡のずれ）
- 介入回数（再生中にオペレータが手動で止める回数）
- 停止率（安全停止が適切なタイミングで発生したかの成功率）
- 最小クリアランス（障害物との最小距離）

### 価値
一度安全を確認した経路を反復実行できれば、デモや検証、定期作業の品質と安全性が向上します。逆再生で「帰り道」も自動化されれば、工数削減と安心感が大きく高まります。

---

## ステージ2: ワンボタン・ミッション（アーム→離陸→ホバ→前進→ホバ→着陸）

### 目的
無線指示の一発操作で、決められた一連のシーケンス（例：2m離陸→5秒ホバリング→前方2m移動→5秒ホバリング→着陸）を自動実行します。

### 方法
- **ステートマシン**: IDLE → ARM → TAKEOFF → HOVER → MOVE_X → HOVER → LAND → DONE
- **MAVROS インタフェース**:
  - アーム: `/mavros/cmd/arming`（srv: CommandBool）
  - モード変更: `/mavros/set_mode`（GUIDED / LOITER など）
  - 位置目標: `/mavros/setpoint_position/local` か `/mavros/setpoint_raw/local`
  - 離陸高度: `/mavros/cmd/takeoff` またはローカル位置 setpoint でステップ実装
- **パラメータ**: takeoff_altitude, dx, hover_seconds でカスタマイズ可能
- **安全**:
  - アーム前チェック（IMU/RC/EKF 健全性）
  - タイムアウト時は LOITER 退避、外部停止指示で DISARM

### KPI
- 成功率（最初から最後まで完走できた割合）
- 所要時間、介入率

### 価値
オペレータの負荷と操作ミスを減らし、デモや定形作業を安全に自動化できます。現場での信頼性・再現性が高まります。

---

## ステージ3: ミッション拡張（複数ウェイポイント）

### 目的
四角形コース、8の字、高度変化など、より複雑なウェイポイント列を自動実行します。

### 方法
- **ウェイポイント列**: YAML/CSV から読み込み、順次 setpoint を配信
- **到達判定**: 距離・yaw の許容誤差を設定し、次のウェイポイントへ遷移
- **速度プロファイル**: `/mavros/setpoint_raw/local` で速度/加速度/yaw_rate の上限を明示
- **パラメータ化**: ウェイポイント、速度上限、到達許容誤差などを外部ファイルで管理

### 価値
定型ミッションを柔軟に構成できるため、検査、巡回、データ収集の汎用性が大幅に向上します。

---

## ステージ4: 別PCでのリモート地図表示

### 目的
同一ネットワーク内の別 PC で、地図・軌跡・機体状態を可視化し、現場と遠隔で同じ情報を共有します。

### 方法
- 別 PC に GLIM/RViz2 を導入。 `/livox/lidar`, `/livox/imu` を DDS 経由で受信し、地図・オドメトリを生成/配信。
- rosbag は最小限のトピック（odom, map keyframes, tf）だけ記録。
- chrony/PTP で時刻同期。 `/mavros/timesync_status` を監視。

### 価値
運用現場での状況把握が容易になり、レビュー時間やヒューマンエラーが減少します。関係者の理解と合意形成も加速します。

---

## ステージ5: 障害物検知と安全停止

### 目的
前方の最小距離が閾値未満の場合に飛行を停止し、重大事故の芽を事前に摘みます。

### 方法
- **近接停止（短期）**: `/livox/lidar` の最近接点を監視。閾値（例：2m）未満で `std_msgs/Bool stop_request=true` を出力し、ミッションノードが setpoint 配信を抑止。
- **前方占有（中期）**: 前方ボクセル/リングバッファの占有に基づく減速→停止。
- **ローカルプランナ（長期）**: RRT*/ESDF 勾配ベースで安全回廊を確保。

### KPI
- 停止の適時性（誤停止と見逃しの比率）
- 減速開始距離、停止距離

### 価値
基本の安全機能を標準化することで、現場での信頼性が格段に高まります。

---

## ステージ6: ゆっくり進みながらの経路生成（短ホライズン）

### 目的
未知環境でも低速で安全に自律移動し、リアルタイムで安全な道を選び続けます。

### 方法
- **地図構築**: `/glim_ros/odom` + `/livox/lidar` から、占有/ESDF 地図をオンラインで更新（OctoMap/Voxblox/NVBlox 相当）。
- **ダウンサンプル・地面分離**: 点群を軽くし、地面成分を除外してマップ精度を確保。
- **ローカルプランナ（2–5 Hz 再計画）**:
  - 2D: DWA/TEB + 膨張コストマップ（機体半径＋マージン）
  - 3D: RRT* or ESDF 勾配ベース
  - 短いゴール（3〜5m）を逐次設定し、到達したら次のゴールを動的に更新
- **追従**: 20Hz で `/mavros/setpoint_raw/local` に配信（vx,vy≤0.5 m/s, vz≤0.3 m/s, yaw_rate≤15°/s）
- **安全**: 地図未更新時は減速→停止。RC介入で即LOITER。

### KPI
- 再計画成功率、平均速度、最小クリアランス、停止回数

### 価値
未知領域の探索基盤が整い、低速での自律移動が可能になります。現場での応用範囲が大きく広がります。

---

## ステージ7: 充電ステーション自動着陸（ドッキング）

### 目的
自動充電を実現し、稼働率を向上させます。長時間巡回や定期観測の中核機能になります。

### 方法
- **誘導方式（いずれか）**:
  - マーカー誘導: 下向きカメラで AprilTag/ArUco を検出し、ステーション姿勢を推定。XY/yaw を微修正しながら最終降下。
  - Precision Landing: ArduPilot PLND（`/mavros/landing_target/pose_in`）で供給（PLND_ENABLED=1, PLND_TYPE=1）。
  - ビーコン: UWB/IR/LiDAR ビーコンで XY 補正（照明に依存しない）。
- **ステーション設計**:
  - 接点式: 整列コーン/ファンネルで自己整列。スプリング端子で接点確保。
  - 非接触: Qi/独自コイルで給電。
  - 検出: 接触検出・電圧監視・極性/短絡保護・耐候設計。
  - マーカー: 中央に主タグ、周囲に補助タグでロバスト化。
- **手順（例）**:
  1. GLIM 座標でステーション上空（≈2 m）へ移動
  2. 降下しつつタグ捕捉（≈0.5–1.0 m）→ XY/yaw 微修正（ビジュアルサーボ）
  3. LAND_SPEED 低速で最終降下 → 接触検出 → モータ停止 → 充電開始
  4. 充電完了後、再アーム可能化
- **設定の要点**:
  - MAVROS/ArduPilot: PLND パラメータ、LAND_SPEED、RNGFND（近接高度）
  - リスク対策: 照明/反射、風・地面効果、喪失時リトライ上限・退避（LOITER）

### KPI
- ドッキング成功率、平均試行回数、平均導入時間

### 価値
充電の自動化により、人手を介さず繰り返し運用できます。長時間稼働や夜間巡回の前提となります。

---

## ステージ8: 専用ビューワ（Ubuntu → Windows）

### 目的
点群のレビュー・報告資料作成・異常解析を迅速に行うためのツールを提供します。

### 方法
- **Ubuntu MVP（Python）**: Open3D + ROS 2 で実装
  - `/livox/lidar` 購読 → PointCloud2 変換 → Open3D 表示
  - 色付け（強度/時間/リング番号）、ボクセルダウンサンプル、FPS/遅延表示
  - 録画/再生、ROI/クリッピング
- **高機能化（C++）**: 必要なら Qt + VTK/PCLVisualizer、または RViz2 プラグイン
  - 計測ツール（距離/面/体積）、スクリーンショット/動画出力
  - LOD/タイル/GPU バッファで大規模点群対応
- **Windows移植**:
  - ROS 2 Windows、または独自通信（TCP/UDP/gRPC）＋スタンドアロン Viewer で移植。

### KPI
- レビュー時間短縮、解析の再現性、資料化の効率

### 価値
現場や事務所で点群データを即座に確認し、報告や分析に活かせます。運用のフィードバックサイクルが加速します。

---

## ステージ9: 堅牢性と安全の強化

### 目的
EKF 健全性の監視、無線断対策、バッテリ/温度監視を標準化し、信頼性を底上げします。

### 方法
- **EKF 監視**: `/mavros/estimator_status` が不健全なら LOITER 指示。 `/mavros/state` が期待と異なればミッション中断。
- **無線断対策**: RC failsafe → RTL/LOITER。ミッションノードのハートビート途絶 N 秒 → setpoint 停止。
- **バッテリ/熱監視**: 電圧・電流・温度の閾値到達で警告や RTL/ドッキング分岐。
- **ログ保存**: rosbag の自動記録、時刻同期（chrony/PTP）で事後解析を容易に。

### 価値
運用時の不測の事態に自動対応できるため、オペレータの安心感とシステムの稼働率が向上します。

---

## ステージ10: 機械学習を用いた高度ミッション

### 目的
記録・再生で蓄積したデータを活用し、より賢く・安全に・滑らかに飛行する自律性を強化します。

### 各手法

#### 10.1 模倣学習による航路追従
- **狙い**: 手動飛行のデータセットから「うまい飛び方」を学習し、同等の追従を自律で再現。
- **入出力**: 過去の局所状態（相対位置・障害物特徴）→ 次時刻の速度/姿勢コマンド。
- **データ**: ステージ1の記録を学習用に流用。
- **評価**: 追従誤差、介入回数、停止率で古典制御と比較。
- **安全**: 学習モデルが不安定なら古典制御にフォールバック。

#### 10.2 物体認識ベースのミッション化
- **狙い**: カメラでタグ/対象物を検出し、GLIM 座標に投影して自動ウェイポイント生成。
- **用途**: ドッキング、特定物体への接近/撮影/離脱など。
- **方法**: AprilTag/ArUco 検出 → GLIM 座標へ投影 → 自動生成されたウェイポイントをミッションに組み込み。

#### 10.3 学習型ローカルプランナ（古典補完）
- **狙い**: DWA/TEB/RRT* に学習コスト（安全/快適/滑らか）を加え、統計的に補正。
- **成果**: クリアランス違反率↓、軌道の曲率変化↓、到達率↑。
- **安全**: 必ず古典プランナにフォールバック可能にし、未知環境でも破綻しない。

#### 10.4 異常検知・フェイルセーフ
- **狙い**: IMU/電流/温度/風推定から早期に「おかしい兆候」を検知。
- **方法**: One-Class SVM/AutoEncoder/IsolationForest で異常スコア化、閾値超過で LOITER/RTL へ早期移行。
- **成果**: 事故前の退避率向上。

#### 10.5 航続・バッテリ予測
- **狙い**: 速度・風・重量から残航続/帰還可否を回帰学習し、ミッション分岐（早期帰還/着陸）。
- **成果**: 無駄なバッテリ切れ・未帰還ゼロ化。

#### 10.6 セマンティクス地図
- **狙い**: LiDAR + カメラで地面/歩道/芝/水面を学習し、通行可否を強化。
- **成果**: 偽障害物/誤判定の減少。

#### 10.7 学習型ランディング補助
- **狙い**: 下向きカメラの特徴点トラッキング＋小型ネットで XY 微修正ゲインを学習（最終整列の頑健化）。
- **成果**: ドッキング成功率向上。

### 優先導入順
1. 模倣学習（記録・再生の延長で導入容易）
2. 物体認識ミッション（タグ接近/ドッキング）
3. 異常検知・バッテリ予測（安全性向上）
4. 学習型ローカルプランナ（段階導入、フォールバック常備）

### 価値
良質なデータを活かし、再現性・安全性・快適性を段階的に積み上げます。

---

## 付録A: 実装予定パッケージ
- `loiter_mission_recorder` / `loiter_mission_replayer`（ステージ1）
- `loiter_mission`（ステージ2/3）
- `local_mapper` + `local_planner`（ステージ5/6）
- `dock_vision_bridge`（ステージ7: AprilTag→PLND入力）

---

## 付録B: その他のアイデア（実現性 低 → 高）

### マルチ機・挑戦的領域
- **領域分割カバレッジ**: 複数機で同一エリアを分割し、衝突回避と通信疎通を確保しながら効率よくカバー。通信リレーや役割分担の最適化が必要。
- **リレー通信**: メッシュネットワークで遠距離ミッション時の通信範囲を拡大。MANET 系プロトコルの検討。
- **移動体着陸**: 移動プラットフォーム（船舶/台車）への着陸。緩加速度追従＋ビジョン補正で相対位置を維持。揺動/加速度の予測が鍵。
- **事前地図からの自動点検経路**: CAD/点群地図から巡回・点検ルートを自動抽出。観測条件（視野角/距離）を充足する経路を最適化。

### 運用自動化
- **データ収集→クラウドKPI**: rosbag/地図を自動アップロード、KPI（走行距離/介入率/成功率/電力消費）をダッシュボード化。
- **夜間巡回（ドッキング運用）**: 定時にドックを出て巡回→帰還→充電を繰り返す完全自動化。スケジュール管理と異常時の自動通報。

### HMI/可視化
- **RViz2 HUD**: 運用に必要な状態（バッテリ/風/ミッション進行/EKF状態）を HUD プラグインで統合表示。
- **AR アノテーション**: HoloLens/スマホで現場に AR タグを重畳。点検箇所や注意点を直感的に表示し、作業効率と安全性を向上。

### アクティブセンシング
- **視点最適化**: 点群の不確かさを低減する視点を計画的に選び、観測品質を自動で最大化。
- **ロバスト再ローカライズ**: GNSS 拒否環境でも、特徴豊富な地図領域へ自動で戻って位置を再推定。長距離飛行での累積誤差を補正。

### ビジョン応用
- **サーマル/マルチスペクトル**: 発熱源・人物・動物サーチ、植生分析など。昼夜問わず運用範囲を拡大。
- **マーカー無し精密着陸**: 特徴点トラッキングだけで微修正（タグ不要）。自然地形やマーカー設置困難な場所でも精密着陸。

### マップ・経路
- **フロンティア探索**: 未観測領域を自動で探索してカバレッジ率向上。ゴール選定と優先度付けの最適化が鍵。
- **ESDF の k-最短**: ESDF 地図で k 本の経路候補を計算し、動的障害物や風を考慮して最適経路を動的選択。
- **地形追従**: 地面との最低高度を維持しつつ、傾斜検出で速度制限。起伏のある環境での安定飛行を実現。
- **セマンティクス地図**: LiDAR + カメラで地面/歩道/芝/水面を学習し、通行可否や経路コストを強化。

### 実運用強化
- **風推定＋対風制御**: EKF外の風力推定で速度指令を補正し、追従精度と快適性を向上。
- **フェイルセーフ拡張**: センサ冗長化切替（IMU/Baro の二重化）、グレースフル降下ロジック（最低限の高度確保）。
- **時刻同期の健全性監視**: chrony/PTP のズレ監視、異常時に警告や自動補正。

---

## 付録C: 安全・運用の基本（全ステージ共通）
- RC 介入で即 LOITER。速度・加速度上限は必ず設定。
- EKF 健全性が悪化したら自動退避。無線断は RTL/LOITER。
- ログ保存と時刻同期（chrony/PTP）、温度/電圧の常時監視。
- ジオフェンス・高度上限・タイムアウトを標準化。

---

## 付録D: 優先導入の考え方

実装難易度と価値の高さから、次の順で進めるのが合理的です。

1. **記録・再生（逆再生）**: 即効性が高く、手順が明確。実装容易、価値実感しやすい。
2. **ワンボタンミッション**: 安全デモに直結、オペレータ負荷を即座に軽減。
3. **障害物停止**: 最小限の安全機能として必須。基盤の信頼性が底上げされる。
4. **リモート地図表示**: 運用での可視化が整い、関係者の共通理解が加速。
5. **ゆっくり自律（短ホライズン経路生成）**: 未知探索基盤が整い、応用範囲が広がる。
6. **充電ドッキング**: 自動運用の中核。長時間稼働に不可欠。
7. **専用ビューワ**: 点群の運用・分析・資料化の効率を高める。
8. **堅牢性強化**: 信頼性と稼働率を向上。
9. **機械学習（模倣/異常検知/認識ミッション/ローカルプランナ）**: データ蓄積後に導入、段階的に効果を積む。

この順序は、価値の即効性と実装難易度のバランスを最適化しています。各ステージで KPI を計測し、成果を確認してから次へ進めば、投資対効果が最大化されます。

---

## まとめ

本計画は、「すぐ効く」安全・運用基盤から着手し、段階的に自律性と知能を積み上げる現実的な構成です。すでに LOITER の安定化と一発起動が整っており、次の投資は記録・再生とワンボタンミッションが最も効果的です。以降は、障害物停止・リモート可視化で運用の土台を固め、低速自律・ドッキングで自動運用に踏み出します。学習の導入は良質な実データ（記録・再生）を活かせるため投資効率が高く、異常検知・航続予測は安全と稼働率を両立させます。

各ステージで成果を確認しながら進めることで、現場価値を最大化し、リスクを最小化します。

---

## 付録E: 技術的補足

### 座標系と frame の扱い
- `frame_id=odom` は局所一貫（ドリフト容認、ジャンプしづらい）で飛行制御に向きます。
- `frame_id=map` は世界基準（再ローカライズでジャンプ可能）で地図整合が必要なときに選択。
- `child_frame_id=base_link` は機体座標系で統一。

### covariance（分散）の調整
- pose/twist の対角分散を大きくすると EKF は慎重（平滑寄り）、小さくすると敏感（追従寄り）になります。
- 詳細は `Libox2Glim.md`（セクション13）を参照。XY/Z/Yaw の揺れに応じて +0.01〜0.03 刻みで微調整。

### タイムスタンプ整合
- 原則は GLIM の時刻を使用（`override_stamp_with_now=false`）。 MAVROS の timesync で FCU 時刻に寄せられます。
- chrony/PTP での時刻同期が推奨されます。

### DDS とネットワーク
- 同一サブネット内でブロードキャスト/マルチキャストを許可。
- Docker 越しは DDS 設定で詰まることがあるため、ホスト直上での実行が無難です。

これらの技術的前提は、各ステージで共通して必要になる基礎知識です。
