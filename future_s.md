# これからの計画（やさしい解説版）

この文書は、今の「ホバリングが安定してできる状態」から、少しずつ機能を増やしていくための道しるべです。むずかしい言葉はできるだけ使わず、どの順番で取り組めばよいかを分かりやすく説明します。

---

## 1. 今できていること（出発点）
- LiDAR（Livox MID360）と自己位置推定（GLIM）で、機体の位置・姿勢が分かる
- MAVROS とブリッジで、自己位置をフライトコントローラ（EKF3）に渡せる
- LOITER（その場ホバリング）が安定
- tmux スクリプトで一発起動できる

ここまでできていれば、次のステップへ進む準備はOKです。

---

## 2. 手動飛行の「記録・再生」からはじめよう
- まずは、手でうまく飛ばした経路を「記録」して、同じルートを「自動で再生」します。
- 記録する項目（例）: 位置（x,y,z）・向き（yaw）・時間
- 再生は 20Hz くらいで位置指令を送り続けると、なめらかに動きます。
- 逆再生（来た道を戻る）も可能です。
- コツ: 速すぎる指令は危ないので、速度と加速度の上限を決めておきます。

---

## 3. ワンボタンのミッション（アーム→離陸→ホバ→前進→ホバ→着陸）
- 無線からの「開始」指示で、決められた一連の動作を自動で行います。
- 例: 2m まで上昇→5秒ホバ→前へ2m→5秒ホバ→着陸。
- 途中で危ないと感じたら、RC のスイッチで LOITER に戻せるようにします。

---

## 4. ミッションを増やす（四角コースや8の字）
- ウェイポイント（通過点）を並べてコースを作ります。
- 到達判定（どれくらい近づいたらOKか）を決め、次の点へ進みます。
- 速度の上限を設定して、急な動きにならないようにします。

---

## 5. 別PCで地図を見よう（リモート表示）
- 同じネットワーク内の PC に GLIM/RViz2 を入れて、地図と軌跡を見えるようにします。
- 記録が必要なら、最小限のトピックだけ rosbag で保存します。
- 時刻がズレないよう、chrony などで時計合わせをしておきます。

---

## 6. ゆっくり進みながら安全な道を探す
- 低い速度で動きながら、LiDAR の点群から「通れる場所・通れない場所」を作ります。
- 近い将来の短いゴール（3〜5m先）だけを見て、安全な道を選び直しながら進みます。
- 危なくなったら減速や停止、RC 介入で LOITER に戻せるようにします。

---

## 7. 障害物を見つけたら止まる（安全第一）
- 前方の一定範囲で、LiDARの最小距離がしきい値より小さくなったら停止します。
- 中期的には、前方の占有情報（空いている/ふさがっている）を使って減速→停止。

---

## 8. 充電ステーションに自動で着陸する
- 下向きカメラでマーカー（AprilTag など）を見つけ、XY と向きを少しずつ合わせます。
- 最後はゆっくり降下して、接触を検知したらモータ停止・充電開始。
- 失敗したらいったん上昇→やり直し。無理なら LOITER で待機します。

---

## 9. 安全・信頼性を強化する
- EKF の状態が悪いときは LOITER に自動で戻す
- 無線が切れたら RTL/LOITER に切替
- バッテリや温度の監視、ログの自動保存

---

## 10. もっと賢く（機械学習の活用）
- 模倣学習: 手動飛行のデータから「上手な飛び方」を学習し、似た状況で同じように飛ぶ
- 物体認識ミッション: タグ/物体を見つけて自動で接近・観測
- 異常検知: センサの値から早めに「おかしい兆候」を見つけて、安全側に
- 学習型プランナ: 古典的な経路計画に学習の考え方を足して、より安全・滑らかに

---

## 11. 専用ビューワを作る（Ubuntu → Windows）
- まずは Ubuntu で Open3D + ROS 2（Python）で MVP（最低限の表示）
  - 点群表示、色付け（強度/時間など）、ボクセルで軽く、録画/再生
- その後、必要なら C++ の Qt + VTK/PCLVisualizer や RViz2 プラグインへ
- Windows へ移すときは、ROS 2 を入れるか、独自通信で Viewer を独立させます

---

## 12. どれから始める？（おすすめ順）
1) 記録・再生（逆再生）
2) ワンボタンミッション
3) 障害物検知・安全停止
4) リモート地図表示
5) ゆっくり経路生成（短い距離で再計画）
6) 充電ステーション自動着陸
7) 機械学習（模倣学習 → 物体認識 → 異常検知）

---

## 付録A: 用語をやさしく
- GLIM: LiDAR と IMU から、機体の現在位置を推定するソフト
- MAVROS: 機体とPCの橋渡しをするソフト（コマンドや状態をやりとり）
- EKF3: 機体の頭脳の一部。位置や速度を統合して、いちばん信頼できる値にする
- LOITER: その場でホバリング（位置を維持）するモード
- 充電ドック/ドッキング: 自動で決められた場所に着陸して充電すること

---

## 付録B: 安全のメモ
- RC 介入ですぐに LOITER に戻せるスイッチを用意
- 速度・加速度の上限を必ず設定
- 何か変だと思ったら、その場で止める・高く上がる・距離を取る

---

この順番で少しずつ進めていけば、現実的な工数で確実にレベルアップできます。分からない箇所があれば、その都度この文書と `Libox2Glim.md` を見比べながら進めてください。
